{#
 # ---------------------------------------------------------------------
 #
 # GLPI - Gestionnaire Libre de Parc Informatique
 #
 # http://glpi-project.org
 #
 # @copyright 2015-2023 Teclib' and contributors.
 # @copyright 2003-2014 by the INDEPNET Development Team.
 # @licence   https://www.gnu.org/licenses/gpl-3.0.html
 #
 # ---------------------------------------------------------------------
 #
 # LICENSE
 #
 # This file is part of GLPI.
 #
 # This program is free software: you can redistribute it and/or modify
 # it under the terms of the GNU General Public License as published by
 # the Free Software Foundation, either version 3 of the License, or
 # (at your option) any later version.
 #
 # This program is distributed in the hope that it will be useful,
 # but WITHOUT ANY WARRANTY; without even the implied warranty of
 # MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 # GNU General Public License for more details.
 #
 # You should have received a copy of the GNU General Public License
 # along with this program.  If not, see <https://www.gnu.org/licenses/>.
 #
 # ---------------------------------------------------------------------
 #}

{% set is_ajax = data['searchform_id'] is defined and data['searchform_id'] is not null %}
{% set fluid_search = fluid_search|default(true) %}
{% if not is_ajax %}
   <div class="ajax-container search-display-data">
{% endif %}
{% set push_history = push_history is defined and push_history %}
{% set hide_controls = data['search']['hide_controls'] or (hide_controls is defined and hide_controls) %}

{# Remove namespace separators for use in HTML attributes #}
{% set normalized_itemtype = itemtype|replace({'\\': ''}) %}

<form id="massform{{ normalized_itemtype }}{{ rand }}" method="get" action="{{ path('front/massiveaction.php') }}"
      data-search-itemtype="{{ data['itemtype'] }}" data-start="{{ start }}" data-count="{{ count }}" data-limit="{{ limit }}" data-submit-once>
   <div class="card card-sm mt-0 search-card">
      {% if not hide_controls %}
         <div class="card-header d-flex justify-content-between search-header pe-0">
            {% if data['display_type'] == constant('Search::GLOBAL_SEARCH') %}
               <h2>{{ itemtype|itemtype_name }}</h2>

               {% if count > (start + constant('Search::GLOBAL_DISPLAY_COUNT')) %}
                  <a href="{{ href }}">
                     <i class="far fa-eye"></i>
                     {{ __('View all') }}
                  </a>
               {% endif %}
            {% else %}
               {{ include('components/search/controls.html.twig') }}
            {% endif %}
         </div>
      {% endif %}

      {% if data['search']['as_map'] == 0 %}
         {{ include('components/search/table.html.twig') }}
      {% elseif count > 0 %}
         {{ include('components/search/map.html.twig') }}
      {% endif %}
      {% if count > 0 %}
         {% if data['display_type'] != constant('Search::GLOBAL_SEARCH') and data['search']['as_map'] == 0 %}
            <div class="card-footer search-footer">
               {{ include('components/pager.html.twig') }}
            </div>
         {% endif %}
      {% elseif data['search']['as_map'] == 1 %}
         <div class="alert alert-info mb-0 rounded-0 border-top-0 border-bottom-0 border-right-0" role="alert">
            {{ __('No item found') }}
         </div>
      {% endif %}
   </div>
</form>

{% if not is_ajax %}
   </div>

   {% if data['search']['as_map'] == 0 %}
      <script>
          window.initFluidSearch{{ rand }}  = () => {
             const allowed_forced_params = ['hide_controls', 'usesession', 'forcetoview', 'criteria'];
             let forced_params = {};
             let all_params = {{ data['search']|default({})|json_encode|raw }};

             $.each(all_params, (k, v) => {
                if (allowed_forced_params.includes(k)) {
                   forced_params[k] = v;
                }
             });

             new GLPI.Search.ResultsView(
                "massform{{ normalized_itemtype }}{{ rand }}",
                GLPI.Search.Table,
                {{ push_history ? "true" : "false" }},
                forced_params
             );
          };
          if (document.readyState === 'complete') {
              initFluidSearch{{ rand }}();
          } else {
              $(document).on('ready', initFluidSearch{{ rand }});
          }
      </script>
   {% endif %}
{% endif %}
